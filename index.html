<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de √Årvore Interativo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .container.editing {
            background: #fff5f5;
        }

        .container.editing .tree {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px dashed #ff6b6b;
        }

        .container.test-mode {
            background: #f0f9ff;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            align-items: center;
        }

        .edit-mode-badge {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            animation: pulse 2s infinite;
        }

        .test-mode-badge {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .mode-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-btn.edit-btn-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .mode-btn.edit-btn-toggle:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
            transform: translateY(-2px);
        }

        .mode-btn.save-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .mode-btn.save-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
            transform: translateY(-2px);
        }

        .controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .controls h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .test-name-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .test-name-input:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            margin-top: 10px;
            padding: 10px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .link-box {
            margin-top: 20px;
            padding: 20px;
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 10px;
        }

        .link-box h3 {
            color: #0d47a1;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .link-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            background: white;
            margin-bottom: 10px;
        }

        .copy-btn {
            background: #2196F3;
            width: 100%;
        }

        .copy-btn:hover {
            background: #1976D2;
        }

        .tree {
            margin-top: 20px;
        }

        .tree-node {
            margin: 10px 0;
        }

        .node-content {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 1;
        }

        .node-content.level-0 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .node-content.level-0:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .node-content.level-1 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.3);
        }

        .node-content.level-1:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.5);
        }

        .node-content.level-2 {
            background: #f8f9fa;
            border-left: 4px solid #4facfe;
            color: #495057;
        }

        .node-content.level-2:hover {
            background: #e9ecef;
            transform: translateX(5px);
            border-left-color: #00f2fe;
        }

        .toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            font-weight: bold;
            font-size: 16px;
            transition: transform 0.3s;
            flex-shrink: 0;
        }

        .node-content.level-2 .toggle {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
        }

        .toggle.collapsed {
            transform: rotate(-90deg);
        }

        .node-label {
            font-weight: 600;
            font-size: 15px;
            flex: 1;
        }

        .edit-controls {
            display: none;
            gap: 5px;
            margin-left: auto;
            position: relative;
            z-index: 10;
        }

        .edit-mode .edit-controls {
            display: flex;
        }

        .edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            margin: 0;
        }

        .add-btn {
            background: #28a745;
            color: white;
        }

        .add-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .children {
            margin-left: 40px;
            padding-left: 20px;
            border-left: 3px solid #e9ecef;
            overflow: hidden;
            transition: all 0.3s ease-out;
        }

        .children.collapsed {
            max-height: 0;
            margin: 0;
            padding: 0;
            opacity: 0;
        }

        .children.expanded {
            max-height: 5000px;
            opacity: 1;
        }

        .info {
            margin-top: 30px;
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 8px;
            color: #0d47a1;
            font-size: 13px;
        }

        .click-counter {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            color: #856404;
            font-size: 14px;
            font-weight: 600;
        }

        .add-root-btn {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: 2px dashed rgba(255,255,255,0.3);
            margin-top: 20px;
            font-size: 16px;
        }

        .add-root-btn:hover {
            background: #218838;
        }

        .export-btn {
            width: 100%;
            padding: 15px;
            background: #17a2b8;
            color: white;
            margin-top: 10px;
            font-size: 16px;
        }

        .export-btn:hover {
            background: #138496;
        }

        .generate-link-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin-top: 10px;
            font-size: 16px;
        }

        .generate-link-btn:hover {
            background: linear-gradient(135deg, #e082ea 0%, #e4465b 100%);
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            margin: 0;
        }

        .cancel-btn {
            background: #6c757d;
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        .success-message {
            padding: 15px;
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            color: #155724;
            margin-top: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagrama de √Årvore Interativo</h1>
        <p class="subtitle">Teste de Navega√ß√£o e Arquitetura da Informa√ß√£o</p>

        <div class="mode-toggle">
            <div id="editModeBadge" class="edit-mode-badge hidden">
                üî• MODO DE EDI√á√ÉO ATIVO
            </div>
            <div id="testModeBadge" class="test-mode-badge hidden">
                üß™ MODO TESTE - Seus cliques est√£o sendo registrados
            </div>
            <button id="editToggleBtn" class="mode-btn edit-btn-toggle" onclick="toggleEditMode()">
                ‚úèÔ∏è Editar
            </button>
        </div>

        <div id="editPanel" class="controls hidden">
            <h3>üè∑Ô∏è Nome do Teste</h3>
            <input type="text" id="testNameInput" class="test-name-input" placeholder="Digite o nome do teste..." value="Teste de Navega√ß√£o 1">
            
            <h3>üìù Edi√ß√£o por CSV</h3>
            <textarea id="csvInput">Node 1, filho 1.1, filho 1.2, filho 1.3
filho 1.1, filho 1.1.1
Node 2, filho 2.1, filho 2.2, filho 2.3, filho 2.4, filho 2.5</textarea>
            <button onclick="loadFromCSV()">üì• Importar do CSV</button>
            
            <button class="generate-link-btn" onclick="generateTestLink()">üîó Gerar Link do Teste</button>
            
            <div id="linkBox" class="link-box hidden">
                <h3>üéØ Link do Teste Gerado</h3>
                <p style="color: #0d47a1; font-size: 13px; margin-bottom: 10px;">Copie e envie este link para o cliente fazer o teste:</p>
                <input type="text" id="generatedLink" class="link-input" readonly>
                <button class="copy-btn" onclick="copyLink()">üìã Copiar Link</button>
                <div id="copySuccess" class="success-message hidden">‚úÖ Link copiado com sucesso!</div>
            </div>
        </div>

        <div id="clickCounter" class="click-counter hidden">
            üìä Cliques registrados: <span id="clickCount">0</span>
        </div>

        <div id="tree" class="tree"></div>

        <button id="addRootBtn" class="add-root-btn hidden" onclick="addRootNode()">
            ‚ûï Adicionar N√≥ Raiz
        </button>

        <button id="exportBtn" class="export-btn hidden" onclick="exportReport()">
            üì• Exportar Relat√≥rio de Cliques
        </button>

        <div class="info">
            <strong id="infoText">üí° Modo Intera√ß√£o:</strong> <span id="infoDesc">Clique nos n√≥s para expandir/colapsar seus filhos. Todos os cliques s√£o registrados.</span>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Adicionar N√≥</h3>
            <input type="text" id="nodeNameInput" placeholder="Nome do n√≥">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Cancelar</button>
                <button onclick="confirmAddNode()">Adicionar</button>
            </div>
        </div>
    </div>

    <script>
        let nodeCounter = 0;
        let currentMode = 'interaction';
        let treeData = [];
        let pendingAddParent = null;
        let nodeIdMap = new Map();
        let clickLog = [];
        let clickCounter = 0;
        let testName = '';
        let isTestMode = false;

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const relationships = [];
            
            lines.forEach(line => {
                const parts = line.split(',').map(s => s.trim());
                if (parts.length > 0 && parts[0]) {
                    const parent = parts[0];
                    const children = parts.slice(1).filter(c => c);
                    relationships.push({ parent, children });
                }
            });
            
            return relationships;
        }

        function treeToCSV(nodes) {
            const lines = [];
            
            function processNode(node) {
                if (node.children.length > 0) {
                    const childNames = node.children.map(c => c.name);
                    lines.push(`${node.name}, ${childNames.join(', ')}`);
                    node.children.forEach(child => processNode(child));
                }
            }
            
            nodes.forEach(node => processNode(node));
            return lines.join('\n');
        }

        function updateCSVFromTree() {
            const csvText = treeToCSV(treeData);
            document.getElementById('csvInput').value = csvText;
        }

        function buildTree(relationships) {
            const nodeMap = new Map();
            
            relationships.forEach(rel => {
                if (!nodeMap.has(rel.parent)) {
                    nodeMap.set(rel.parent, { name: rel.parent, children: [] });
                }
                
                rel.children.forEach(childName => {
                    if (!nodeMap.has(childName)) {
                        nodeMap.set(childName, { name: childName, children: [] });
                    }
                });
            });
            
            relationships.forEach(rel => {
                const parentNode = nodeMap.get(rel.parent);
                rel.children.forEach(childName => {
                    const childNode = nodeMap.get(childName);
                    if (!parentNode.children.includes(childNode)) {
                        parentNode.children.push(childNode);
                    }
                });
            });
            
            const allChildren = new Set();
            relationships.forEach(rel => {
                rel.children.forEach(child => allChildren.add(child));
            });
            
            const rootNodes = [];
            nodeMap.forEach((node, name) => {
                if (!allChildren.has(name)) {
                    rootNodes.push(node);
                }
            });
            
            return rootNodes;
        }

        function logClick(nodeName) {
            if (currentMode === 'edit' || !isTestMode) return;
            
            clickCounter++;
            const timestamp = new Date().toLocaleString('pt-BR');
            clickLog.push({
                click: clickCounter,
                node: nodeName,
                timestamp: timestamp
            });
            
            document.getElementById('clickCount').textContent = clickCounter;
        }

        function toggleNode(nodeId, nodeName) {
            if (currentMode === 'edit') return;
            
            logClick(nodeName);
            
            const children = document.getElementById(`children-${nodeId}`);
            const toggle = document.getElementById(`toggle-${nodeId}`);
            
            if (children) {
                if (children.classList.contains('collapsed')) {
                    children.classList.remove('collapsed');
                    children.classList.add('expanded');
                    toggle.classList.remove('collapsed');
                } else {
                    children.classList.add('collapsed');
                    children.classList.remove('expanded');
                    toggle.classList.add('collapsed');
                }
            }
        }

        function createNodeElement(node, level, nodeId) {
            const hasChildren = node.children.length > 0;
            const levelClass = `level-${Math.min(level, 2)}`;
            
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'tree-node';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `node-content ${levelClass}`;
            contentDiv.onclick = function() { toggleNode(nodeId, node.name); };
            
            const toggleSpan = document.createElement('span');
            if (hasChildren) {
                toggleSpan.id = `toggle-${nodeId}`;
                toggleSpan.className = 'toggle';
                toggleSpan.textContent = '‚ñº';
            } else {
                toggleSpan.style.width = '24px';
            }
            
            const labelSpan = document.createElement('span');
            labelSpan.className = 'node-label';
            labelSpan.textContent = node.name;
            
            const editDiv = document.createElement('div');
            editDiv.className = 'edit-controls';
            
            const addBtn = document.createElement('button');
            addBtn.className = 'edit-btn add-btn';
            addBtn.textContent = '‚ûï Filho';
            addBtn.onclick = function(e) {
                e.stopPropagation();
                addChildNode(nodeId);
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'edit-btn delete-btn';
            deleteBtn.textContent = 'üóëÔ∏è';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                e.preventDefault();
                deleteNode(nodeId);
            };
            
            editDiv.appendChild(addBtn);
            editDiv.appendChild(deleteBtn);
            
            contentDiv.appendChild(toggleSpan);
            contentDiv.appendChild(labelSpan);
            contentDiv.appendChild(editDiv);
            
            nodeDiv.appendChild(contentDiv);
            
            if (hasChildren) {
                const childrenDiv = document.createElement('div');
                childrenDiv.id = `children-${nodeId}`;
                childrenDiv.className = 'children expanded';
                nodeDiv.appendChild(childrenDiv);
            }
            
            return nodeDiv;
        }

        function renderNode(node, level = 0) {
            const nodeId = nodeCounter++;
            nodeIdMap.set(nodeId, node);
            
            const nodeDiv = createNodeElement(node, level, nodeId);
            
            if (node.children.length > 0) {
                const childrenContainer = nodeDiv.querySelector(`#children-${nodeId}`);
                node.children.forEach(child => {
                    childrenContainer.appendChild(renderNode(child, level + 1));
                });
            }
            
            return nodeDiv;
        }

        function renderTree(rootNodes) {
            const treeDiv = document.getElementById('tree');
            treeDiv.innerHTML = '';
            nodeCounter = 0;
            nodeIdMap.clear();
            
            if (currentMode === 'edit') {
                treeDiv.classList.add('edit-mode');
            } else {
                treeDiv.classList.remove('edit-mode');
            }
            
            rootNodes.forEach(node => {
                treeDiv.appendChild(renderNode(node, 0));
            });
        }

        function switchMode(mode) {
            currentMode = mode;
            const container = document.querySelector('.container');
            const editBtn = document.getElementById('editToggleBtn');
            const editBadge = document.getElementById('editModeBadge');
            const testBadge = document.getElementById('testModeBadge');
            const clickCounter = document.getElementById('clickCounter');
            const exportBtn = document.getElementById('exportBtn');
            
            if (mode === 'edit') {
                container.classList.add('editing');
                container.classList.remove('test-mode');
                editBadge.classList.remove('hidden');
                testBadge.classList.add('hidden');
                editBtn.textContent = 'üíæ Salvar';
                editBtn.classList.remove('edit-btn-toggle');
                editBtn.classList.add('save-btn');
                document.getElementById('editPanel').classList.remove('hidden');
                document.getElementById('addRootBtn').classList.remove('hidden');
                clickCounter.classList.add('hidden');
                exportBtn.classList.add('hidden');
                document.getElementById('infoText').textContent = '‚úèÔ∏è Modo Edi√ß√£o:';
                document.getElementById('infoDesc').textContent = 'Adicione ou remova n√≥s clicando nos bot√µes. Use o CSV para importar estruturas complexas.';
            } else {
                container.classList.remove('editing');
                if (isTestMode) {
                    container.classList.add('test-mode');
                    testBadge.classList.remove('hidden');
                } else {
                    testBadge.classList.add('hidden');
                }
                editBadge.classList.add('hidden');
                editBtn.textContent = '‚úèÔ∏è Editar';
                editBtn.classList.add('edit-btn-toggle');
                editBtn.classList.remove('save-btn');
                document.getElementById('editPanel').classList.add('hidden');
                document.getElementById('addRootBtn').classList.add('hidden');
                clickCounter.classList.remove('hidden');
                exportBtn.classList.remove('hidden');
                document.getElementById('infoText').textContent = 'üí° Modo Intera√ß√£o:';
                document.getElementById('infoDesc').textContent = 'Clique nos n√≥s para expandir/colapsar seus filhos. Todos os cliques s√£o registrados.';
            }
            
            renderTree(treeData);
        }

        function toggleEditMode() {
            if (currentMode === 'edit') {
                switchMode('interaction');
            } else {
                switchMode('edit');
            }
        }

        function loadFromCSV() {
            const csvInput = document.getElementById('csvInput').value;
            const relationships = parseCSV(csvInput);
            treeData = buildTree(relationships);
            renderTree(treeData);
        }

        function addRootNode() {
            pendingAddParent = null;
            document.getElementById('modalTitle').textContent = 'Adicionar N√≥ Raiz';
            document.getElementById('nodeNameInput').value = '';
            document.getElementById('modal').classList.add('active');
        }

        function addChildNode(nodeId) {
            pendingAddParent = nodeIdMap.get(nodeId);
            document.getElementById('modalTitle').textContent = 'Adicionar N√≥ Filho';
            document.getElementById('nodeNameInput').value = '';
            document.getElementById('modal').classList.add('active');
        }

        function confirmAddNode() {
            const name = document.getElementById('nodeNameInput').value.trim();
            if (!name) return;
            
            const newNode = { name: name, children: [] };
            
            if (pendingAddParent) {
                pendingAddParent.children.push(newNode);
            } else {
                treeData.push(newNode);
            }
            
            closeModal();
            updateCSVFromTree();
            renderTree(treeData);
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            pendingAddParent = null;
        }

        function deleteNode(nodeId) {
            const nodeToDelete = nodeIdMap.get(nodeId);
            
            function removeNodeFromTree(nodes, target) {
                for (let i = 0; i < nodes.length; i++) {
                    if (nodes[i] === target) {
                        nodes.splice(i, 1);
                        return true;
                    }
                    if (nodes[i].children && nodes[i].children.length > 0) {
                        if (removeNodeFromTree(nodes[i].children, target)) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            if (removeNodeFromTree(treeData, nodeToDelete)) {
                updateCSVFromTree();
                renderTree(treeData);
            }
        }

        function generateTestLink() {
            const name = document.getElementById('testNameInput').value.trim();
            const csv = document.getElementById('csvInput').value.trim();
            
            if (!name || !csv) {
                alert('Por favor, preencha o nome do teste e a estrutura CSV.');
                return;
            }
            
            const testData = {
                name: name,
                csv: csv
            };
            
            const encoded = btoa(encodeURIComponent(JSON.stringify(testData)));
            const url = window.location.origin + window.location.pathname + '?test=' + encoded;
            
            document.getElementById('generatedLink').value = url;
            document.getElementById('linkBox').classList.remove('hidden');
        }

        function copyLink() {
            const linkInput = document.getElementById('generatedLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            document.execCommand('copy');
            
            const successMsg = document.getElementById('copySuccess');
            successMsg.classList.remove('hidden');
            setTimeout(() => {
                successMsg.classList.add('hidden');
            }, 3000);
        }

        function loadTestFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const testParam = urlParams.get('test');
            
            if (testParam) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(testParam)));
                    testName = decoded.name;
                    isTestMode = true;
                    
                    document.getElementById('testNameInput').value = testName;
                    document.getElementById('csvInput').value = decoded.csv;
                    
                    loadFromCSV();
                    
                    const container = document.querySelector('.container');
                    container.classList.add('test-mode');
                    document.getElementById('testModeBadge').classList.remove('hidden');
                    document.getElementById('clickCounter').classList.remove('hidden');
                    document.getElementById('exportBtn').classList.remove('hidden');
                    document.getElementById('editToggleBtn').classList.add('hidden');
                    
                    document.querySelector('h1').textContent = 'üß™ ' + testName;
                    document.querySelector('.subtitle').textContent = 'Clique nos n√≥s para navegar. Seus cliques est√£o sendo registrados.';
                    
                } catch (e) {
                    console.error('Erro ao carregar teste:', e);
                    alert('Link de teste inv√°lido.');
                }
            }
        }

        function exportReport() {
            const name = testName || document.getElementById('testNameInput').value.trim() || 'teste-navegacao';
            const fileName = `${name.replace(/\s+/g, '-').toLowerCase()}-relatorio.txt`;
            
            let report = `RELAT√ìRIO DE TESTE DE NAVEGA√á√ÉO\n`;
            report += `Nome do Teste: ${name}\n`;
            report += `Data: ${new Date().toLocaleString('pt-BR')}\n`;
            report += `Total de Cliques: ${clickCounter}\n`;
            report += `\n${'='.repeat(50)}\n\n`;
            report += `SEQU√äNCIA DE CLIQUES:\n\n`;
            
            clickLog.forEach(log => {
                report += `Clique ${log.click}: ${log.node}\n`;
                report += `  Hor√°rio: ${log.timestamp}\n\n`;
            });
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // Inicializar
        loadTestFromURL();
        if (!isTestMode) {
            loadFromCSV();
        }
    </script>
</body>
</html>
